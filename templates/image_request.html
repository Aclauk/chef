{% include 'header.html.j2' %}
<div class="container">
    <div style="display: none" id="info_box" class="alert alert-info"></div>
    <div style="display: none" id="error_box" class="alert alert-danger"></div>
</div>
<form name="request_form" id="request_form" action="/image_request" method="get">
	<p>
		Distro:
		<select id="distro" name="distro" onchange="distro_changed()">
			{% for distro in distros %}
			<option value="{{ distro["name"] }}">{{ distro["name"] }}</option>
			{% endfor %}
		</select>
	</p>
	<p>
		Release:
		<select id="release" name="release"></select>
	<p>
	</p>
		Profile: <input type="text" id="search_device" onkeyup="search_delayed()" placeholder="Search for device..."></br>
		<select id="profile" name="profile"></select>
	</p>
	<p>
		Network Profile:
		<select name="network_profile">
		<option value="" selected>None</option>
			{% for network_profile in network_profiles %}
			<option value="{{ network_profile }}">{{ network_profile }}</option>
			{% endfor %}
		</select>
	</p>
	<p>
		<input type="button" value="Create image" onclick="image_request()">
	</p>
</form>

<script>
server_address = "https://betaupdate.libremesh.org/"

var delay_timer;
function search_delayed() {
	clearTimeout(delay_timer);
	delay_timer = setTimeout(search, 500);
}

function search() {
	var xmlhttp = new XMLHttpRequest();
	var device = document.getElementById("search_device").value;
	var distro = document.getElementById("distro").value;
	var release = document.getElementById("release").value;

	request_url = server_address + "api/models?model_search=" + device + "&distro=" + distro + "&release=" + release

	xmlhttp.open("GET", request_url, true);

	xmlhttp.onreadystatechange = function () {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			device_results(xmlhttp);
		}
	}
	xmlhttp.send(null);

	function device_results(xmlhttp) {
		devices = JSON.parse(xmlhttp.responseText)
			document.request_form.profile.options.length = 0;
		if(devices.length == 0) {
			document.request_form.profile[0] = new Option("Not found")
		} else {
			for(var i = 0; i < devices.length; i++) {
				document.request_form.profile[i] = new Option(devices[i].model)
				document.request_form.profile[i].value = devices[i].target + "/" + devices[i].subtarget + "/" + devices[i].profile
			}
		}
	}
};

function load_releases() {
	var xmlhttp = new XMLHttpRequest();
	var device = document.getElementById("search_device").value;
	var distro = document.getElementById("distro").value;
	var release = document.getElementById("release").value;

	request_url = server_address + "api/releases"

	xmlhttp.open("GET", request_url, true);

	xmlhttp.onreadystatechange = function () {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			releases_results(xmlhttp);
		}
	}
	xmlhttp.send(null);

	function releases_results(xmlhttp) {
		releases = JSON.parse(xmlhttp.responseText);
		distro_changed();
	}
};

function distro_changed() {
	document.request_form.release.options.length = 0;

	for(var i = 0; i < releases.length; i++) {
		if(releases[i].distro === document.request_form.distro[document.request_form.distro.selectedIndex].value) {
			release_length = document.request_form.release.length
			document.request_form.release[release_length] = new Option(releases[i].release)
		}
	}
	search();
}

function bootstrap() {
	load_releases();
	search();
}
window.addEventListener("load", bootstrap);
</script>
{% include 'footer.html.j2' %}
